#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = "https://qqmtkbgtjbkcmcladybh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxbXRrYmd0amJrY21jbGFkeWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNjE3NzQsImV4cCI6MjA3MTYzNzc3NH0.7WVWg7Yf2fDzWqDYWrdO3Bg6adsBfBv_XbfMNtEWHNo";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function executeDatabaseFixes() {
  console.log('üîÑ Starting database fixes execution...\n');

  try {
    // Step 1: Get category IDs
    console.log('üìã Step 1: Getting current category IDs...');
    const { data: categories, error: categoriesError } = await supabase
      .from('categories')
      .select('id, name, slug')
      .eq('is_active', true)
      .order('name');

    if (categoriesError) {
      console.error('‚ùå Error fetching categories:', categoriesError);
      return;
    }

    console.log('‚úÖ Current categories:');
    categories.forEach(cat => {
      console.log(`   ID: ${cat.id}, Name: ${cat.name}, Slug: ${cat.slug}`);
    });
    console.log('');

    // Create a mapping of category names to IDs
    const categoryMap = {};
    categories.forEach(cat => {
      categoryMap[cat.name] = cat.id;
    });

    // Step 2: Update existing products to correct categories and remove slugs
    console.log('üìù Step 2: Updating existing products with correct categories...');

    const productsToUpdate = [
      { name: 'Compressores Industriais', newCategory: 'Ferramentas El√©tricas' },
      { name: 'Ferramentas Pneum√°ticas', newCategory: 'Ferramentas El√©tricas' },
      { name: 'Sistemas Hidr√°ulicos', newCategory: 'Insumos Industriais' },
      { name: 'M√°quinas Pesadas', newCategory: 'Insumos Industriais' },
      { name: 'Transporte Especializado', newCategory: 'Insumos Industriais' },
      { name: 'Equipamentos de Eleva√ß√£o', newCategory: 'Insumos Industriais' }
    ];

    for (const product of productsToUpdate) {
      const newCategoryId = categoryMap[product.newCategory];
      if (!newCategoryId) {
        console.log(`‚ö†Ô∏è  Category '${product.newCategory}' not found for product '${product.name}'`);
        continue;
      }

      const { data, error } = await supabase
        .from('products')
        .update({
          category_id: newCategoryId,
          slug: null,
          is_active: true
        })
        .eq('name', product.name)
        .select();

      if (error) {
        console.error(`‚ùå Error updating product '${product.name}':`, error);
      } else {
        console.log(`‚úÖ Updated '${product.name}' to category '${product.newCategory}' (ID: ${newCategoryId})`);
      }
    }
    console.log('');

    // Step 3: Insert new products for categories that need them
    console.log('‚ûï Step 3: Inserting new products for empty categories...');

    const newProducts = [
      // Ferro & A√ßo
      {
        name: 'Barras de A√ßo Carbono',
        category: 'ferro-aco',
        category_id: categoryMap['Ferro & A√ßo'],
        description: 'Barras de alta resist√™ncia para constru√ß√£o civil e industrial',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Chapas de A√ßo Galvanizado',
        category: 'ferro-aco',
        category_id: categoryMap['Ferro & A√ßo'],
        description: 'Chapas resistentes √† corros√£o para coberturas e estruturas',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Tubos de Ferro Fundido',
        category: 'ferro-aco',
        category_id: categoryMap['Ferro & A√ßo'],
        description: 'Tubos de ferro para sistemas hidr√°ulicos e estruturais',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      // EPIs
      {
        name: 'Capacetes de Seguran√ßa',
        category: 'epis',
        category_id: categoryMap['EPIs'],
        description: 'Capacetes certificados para prote√ß√£o em obras e ind√∫strias',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: '√ìculos de Prote√ß√£o',
        category: 'epis',
        category_id: categoryMap['EPIs'],
        description: '√ìculos de seguran√ßa para prote√ß√£o contra respingos e impactos',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Luvas de Seguran√ßa',
        category: 'epis',
        category_id: categoryMap['EPIs'],
        description: 'Luvas resistentes para manuseio de materiais e soldagem',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      // Consum√≠veis T√©cnicos
      {
        name: 'Eletrodos de Solda',
        category: 'consumiveis-tecnicos',
        category_id: categoryMap['Consum√≠veis T√©cnicos'],
        description: 'Eletrodos de alta qualidade para soldagem de estruturas met√°licas',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Discos de Corte',
        category: 'consumiveis-tecnicos',
        category_id: categoryMap['Consum√≠veis T√©cnicos'],
        description: 'Discos abrasivos para corte de metais e alvenaria',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Esponjas Abrasivas',
        category: 'consumiveis-tecnicos',
        category_id: categoryMap['Consum√≠veis T√©cnicos'],
        description: 'Esponjas para acabamento e polimento de superf√≠cies',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      // Ferramentas √† Bateria
      {
        name: 'Furadeira a Bateria',
        category: 'ferramentas-bateria',
        category_id: categoryMap['Ferramentas √† Bateria'],
        description: 'Furadeira port√°til com bateria de longa dura√ß√£o',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Parafusadeira a Bateria',
        category: 'ferramentas-bateria',
        category_id: categoryMap['Ferramentas √† Bateria'],
        description: 'Parafusadeira de alta performance para montagem',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Serra Tico-Tico a Bateria',
        category: 'ferramentas-bateria',
        category_id: categoryMap['Ferramentas √† Bateria'],
        description: 'Serra port√°til para cortes precisos em madeira e metal',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      // Ferramentas Manuais
      {
        name: 'Martelos de Carpinteiro',
        category: 'ferramentas-manuais',
        category_id: categoryMap['Ferramentas Manuais'],
        description: 'Martelos de a√ßo forjado para carpintaria e constru√ß√£o',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Chaves de Fenda e Philips',
        category: 'ferramentas-manuais',
        category_id: categoryMap['Ferramentas Manuais'],
        description: 'Conjunto de chaves manuais para manuten√ß√£o',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Alicates Universais',
        category: 'ferramentas-manuais',
        category_id: categoryMap['Ferramentas Manuais'],
        description: 'Alicates de bico e universal para trabalhos el√©tricos',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      // Solda & Acess√≥rios
      {
        name: 'M√°quina de Solda MIG',
        category: 'solda-acessorios',
        category_id: categoryMap['Solda & Acess√≥rios'],
        description: 'Equipamento profissional para soldagem MIG/MAG',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'Tochas de Solda',
        category: 'solda-acessorios',
        category_id: categoryMap['Solda & Acess√≥rios'],
        description: 'Tochas de alta qualidade para soldagem a g√°s',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      },
      {
        name: 'M√°scaras de Soldador',
        category: 'solda-acessorios',
        category_id: categoryMap['Solda & Acess√≥rios'],
        description: 'M√°scaras autom√°ticas com prote√ß√£o UV para soldagem',
        is_active: true,
        slug: null,
        price: null,
        sku: null
      }
    ];

    // Insert products one by one to handle conflicts
    for (const product of newProducts) {
      if (!product.category_id) {
        console.log(`‚ö†Ô∏è  Category ID not found for product '${product.name}' in category '${product.category}'`);
        continue;
      }

      // Check if product already exists
      const { data: existingProduct } = await supabase
        .from('products')
        .select('id, name')
        .eq('name', product.name)
        .single();

      if (existingProduct) {
        console.log(`‚è≠Ô∏è  Product '${product.name}' already exists, skipping...`);
        continue;
      }

      const { data, error } = await supabase
        .from('products')
        .insert(product)
        .select();

      if (error) {
        console.error(`‚ùå Error inserting product '${product.name}':`, error);
      } else {
        console.log(`‚úÖ Inserted product '${product.name}' in category '${product.category}'`);
      }
    }
    console.log('');

    // Step 4: Verify results
    console.log('üîç Step 4: Verifying results...');

    const { data: finalResults, error: finalError } = await supabase
      .from('categories')
      .select(`
        id,
        name,
        slug,
        products:products(
          id,
          name,
          description,
          category_id,
          slug,
          price,
          sku,
          is_active
        )
      `)
      .eq('is_active', true)
      .order('name');

    if (finalError) {
      console.error('‚ùå Error fetching final results:', finalError);
      return;
    }

    console.log('üìä Final Results - Categories with Products:');
    console.log('=========================================');

    finalResults.forEach(category => {
      console.log(`\nüè∑Ô∏è  Category: ${category.name} (ID: ${category.id})`);
      console.log(`   Slug: ${category.slug}`);
      console.log(`   Products: ${category.products?.length || 0}`);

      if (category.products && category.products.length > 0) {
        category.products.forEach(product => {
          console.log(`     ‚Ä¢ ${product.name} (ID: ${product.id})`);
          console.log(`       Description: ${product.description}`);
          console.log(`       Category ID: ${product.category_id}`);
          console.log(`       Slug: ${product.slug || 'NULL'}`);
          console.log(`       Active: ${product.is_active}`);
          console.log('');
        });
      } else {
        console.log('     No products found');
      }
    });

    // Product count per category
    console.log('\nüìà Product Count per Category:');
    console.log('==============================');
    finalResults.forEach(category => {
      const activeProducts = category.products?.filter(p => p.is_active) || [];
      console.log(`${category.name}: ${activeProducts.length} active products`);
    });

    console.log('\nüéâ Database fixes completed successfully!');

  } catch (error) {
    console.error('üí• Unexpected error:', error);
  }
}

// Run the script
executeDatabaseFixes();